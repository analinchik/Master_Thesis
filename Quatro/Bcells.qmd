---
title: "B cells"
format: 
  html:
    embed-resources: true
    theme: flatly
    toc: true
    toc-depth: 3
    toc-expand: 3
    toc-title: Contents
    smooth-scroll: true
editor: visual
---

```{r}
#| echo: false
#| include: false
library(dplyr)
library(ggplot2)
library(tidyr)
library(readxl)
library(kableExtra)
library(ggpubr)
library(stringr)
library(VennDiagram)
```

```{r}
#| echo: false
#| include: false

# hl
Bcells_hl <- read.csv(file = '/Users/anastasialinchik/Desktop/Thesis/DATA/generated/Bcells_hl.tsv', header = T, sep = '\t')

#THIS LOADS THE NEW DATASET
human_complete <- read.csv(file = "/Users/anastasialinchik/Desktop/Thesis/DATA/generated/human_new.tsv", header = T, sep = '\t')

leadprot_uniprot <- human_complete %>% dplyr::select(Uniprot_entry_name, LeadProt) %>% distinct()

human_ptms <- human_complete %>% filter(ptm_class == 'Post-translational')

# MODIFICATIONS
oxPTMs <- read_excel(path = '/Users/anastasialinchik/Desktop/Thesis/table_oxPTMs.xlsx', sheet = 'oxPTMs')
oxPTMs <- oxPTMs %>%
  mutate(AAs_list = str_split(Specificity, ", ")) %>% dplyr::select(`Unimod #`, AAs_list) %>% rename(unimod_id = `Unimod #`)

lysine_acylation <- c(122, 1, 58, 1289, 747, 64)
AGE <- c(6, 907, 378)
```

cytoplasmic projects:

-   old B cells: PXD006570

-   young B cells:PXD006572

nuclear proteins:

-   old B cells:PXD006571

-   young B cells:PXD006576

there were 3 young donors and 3 elderly donors

```{r}
#| echo: false

human_ptms_cyto_old <- human_complete %>% filter(project_id == 'PXD006570')
human_ptms_cyto_young <- human_complete %>% filter(project_id == 'PXD006572')

human_ptms_nuc_old <- human_complete %>% filter(project_id == 'PXD006571') 
human_ptms_nuc_young <- human_complete %>% filter(project_id == 'PXD006576')
```

# Histones

Methylation of histones. Do histones get more methylised as we age? compare the mean of the sum of modifications of histones in young and old cells. Do this for cytoplasmic and nuclear proteins.

Where are the histones from?

```{r}
#| echo: false
histones <- read.csv(file = '/Users/anastasialinchik/Downloads/idmapping_2024_04_30.tsv', header = T, sep = '\t')

histones_mod_old <- human_ptms_nuc_old %>% filter(LeadProt %in% histones$Entry)
histones_mod_young <- human_ptms_nuc_young %>% filter(LeadProt %in% histones$Entry)
```

```{r}
#| echo: false

df2 <- histones_mod_young %>% filter(unimod_id == 34) %>% group_by(Uniprot_entry_name) %>% summarise(sum = sum(counts_norm_abund_len)) %>% distinct() %>% mutate(group = 'young')
df1 <- histones_mod_old %>% filter(unimod_id == 34) %>% group_by(Uniprot_entry_name) %>% summarise(sum = sum(counts_norm_abund_len)) %>% distinct() %>% mutate(group = 'old') %>% filter(Uniprot_entry_name %in% df2$Uniprot_entry_name)

df <- rbind(df1, df2)
df$group <- factor(df$group, levels = c('young', 'old'))
ggplot(df, aes(y = sum, x = group)) +
  geom_boxplot(outliers = F) +
  scale_y_continuous(labels = scales::label_number(scale = 1e5)) +
  labs(y = 'Sum of normalised counts (scaled by 1e5)') +
  theme_classic() + 
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size = 16, family = "Lato"),
        axis.title = element_text(size = 16, family = "Lato")) 
```

```{r}
#| echo: false
wilcox.test(df1$sum, df2$sum)
```

(maybe it would be better to look at all modifications, not just methylation)

What about modifications in histones in general? Not just methylation? Use only the nuclear groups bcs histones are obviously in the nucleus.

```{r}
#| echo: false
df2 <- histones_mod_young %>% filter(ptm_class == 'Post-translational') %>% group_by(Uniprot_entry_name) %>% summarise(sum = sum(counts_norm_abund_len)) %>% distinct() %>% mutate(group = 'young')
df1 <- histones_mod_old %>% filter(ptm_class == 'Post-translational') %>% group_by(Uniprot_entry_name) %>% summarise(sum = sum(counts_norm_abund_len)) %>% distinct() %>% mutate(group = 'old') %>% filter(Uniprot_entry_name %in% df2$Uniprot_entry_name)

df <- rbind(df1, df2)
df$group <- factor(df$group, levels = c('young', 'old'))
ggplot(df, aes(y = sum, x = group)) +
  geom_boxplot(outliers = F) +
  scale_y_continuous(labels = scales::label_number(scale = 1e4)) +
  labs(y = 'Sum of normalised counts (scaled by 1e4)') +
  theme_classic() + 
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size = 16, family = "Lato"),
        axis.title = element_text(size = 16, family = "Lato")) 
```

```{r}
#| echo: false
wilcox.test(df1$sum, df2$sum)
```

## Enriched PTMs in histones

Which PTMs are enriched in the histones of old cells compared to new?

```{r}
#| echo: false
df1 <- histones_mod_young %>% filter(ptm_class == 'Post-translational') %>% 
  group_by(ptm_name) %>%
  summarise(sum =sum(counts_norm_abund_len))

df2 <- histones_mod_old %>% filter(ptm_class == 'Post-translational') %>% 
  group_by(ptm_name) %>%
  summarise(sum =sum(counts_norm_abund_len))

df3 <- inner_join(df1, df2, by = join_by(ptm_name),  suffix = c('_young', '_old')) %>% 
  filter(sum_old > sum_young) %>%
  mutate(change = sum_old/sum_young)
```

```{r}
#| echo: false
ggplot(df3, aes(y = reorder(ptm_name, change), x = change)) +
  geom_col() +
  labs(y = 'PTMs', x = 'Fold change') +
  theme_classic()
```

# PTMs Chaperones

```{r}
#| echo: false
all_chaperones <- read_excel(path = '/Users/anastasialinchik/Desktop/Thesis/DATA/all_chaperones.xlsx', sheet = 'BREHME_TABLE S2A', skip = 8)

repressed_chaperones <- read_excel(path = '/Users/anastasialinchik/Desktop/Thesis/DATA/subnetwork_chaperones.xlsx', sheet = 'BREHME_TABLE S3D', skip = 19)
repressed_chaperones <- separate_wider_delim(repressed_chaperones, col = 'Label [Family]', names = c("gene_name", "family"), delim = " ")
repressed_chaperones <- inner_join(repressed_chaperones, all_chaperones, by = join_by('Entrez-ID'))

induced_chaperones <- read_excel(path = '/Users/anastasialinchik/Desktop/Thesis/DATA/subnetwork_chaperones.xlsx', sheet = 'BREHME_TABLE S3E', skip = 19)
induced_chaperones <- separate_wider_delim(induced_chaperones, col = 'Label [Family]', names = c("gene_name", "family"), delim = " ")
induced_chaperones <- inner_join(induced_chaperones, all_chaperones, by = join_by('Entrez-ID'))
```

## oxPTMs

Repressed chaperones get more oxPTMs?

Do aged chaperones have more oxPTMs than non-aged?

Not significant for both nuc and cyto

```{r}
#| echo: false
df1 <- human_ptms_cyto_young %>% 
  filter(unimod_id %in% oxPTMs$unimod_id & ptm_res %in% oxPTMs$AAs_list) %>% 
  filter(Uniprot_entry_name %in% all_chaperones$Uniprot) %>% 
  group_by(Uniprot_entry_name) %>% summarise(sum = sum(counts_norm_abund_len)) %>% 
  distinct() %>% mutate(group = 'young')
df2 <- human_ptms_cyto_old %>% 
  filter(unimod_id %in% oxPTMs$unimod_id & ptm_res %in% oxPTMs$AAs_list) %>% 
  filter(Uniprot_entry_name %in% all_chaperones$Uniprot) %>% 
  group_by(Uniprot_entry_name) %>% summarise(sum = sum(counts_norm_abund_len)) %>% 
  distinct() %>% mutate(group = 'old') %>% filter(Uniprot_entry_name %in% df1$Uniprot_entry_name)

df <- rbind(df1, df2)
df$group <- factor(df$group, levels = c('young', 'old'))
ggplot(df, aes(y = sum, x = group)) +
  geom_boxplot(outliers = F) +
  scale_y_continuous(labels = scales::label_number(scale = 1e5)) +
  labs(y = 'Sum of normalised counts (scaled by 1e5)')+
  theme_classic() + 
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size = 16, family = "Lato"),
        axis.title = element_text(size = 16, family = "Lato")) 
```

```{r}
#| echo: false
wilcox.test(df1$sum, df2$sum)
```

## AGEs

NOT FOUND

## Oxidation

```{r}
#| echo: false
df1 <- human_ptms_cyto_young %>% 
  filter(unimod_id == 35) %>% 
  filter(Uniprot_entry_name %in% all_chaperones$Uniprot) %>% 
  group_by(Uniprot_entry_name) %>% summarise(sum = sum(counts_norm_abund_len)) %>% 
  distinct() %>% mutate(group = 'young')
df2 <- human_ptms_cyto_old %>% 
  filter(unimod_id == 35) %>% 
  filter(Uniprot_entry_name %in% all_chaperones$Uniprot) %>% 
  group_by(Uniprot_entry_name) %>% summarise(sum = sum(counts_norm_abund_len)) %>% 
  distinct() %>% mutate(group = 'old') %>% filter(Uniprot_entry_name %in% df1$Uniprot_entry_name)

df <- rbind(df1, df2)
ggplot(df, aes(y = sum, x = group)) +
  geom_boxplot(outliers = F) +
  scale_y_continuous(labels = scales::label_number(scale = 1e5)) +
  labs(y = 'Sum of normalised counts (scaled by 1e5)') +
  theme_classic() + 
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size = 16, family = "Lato"),
        axis.title = element_text(size = 16, family = "Lato")) 
```

```{r}
#| echo: false
wilcox.test(df1$sum, df2$sum)
```

# Fold change

```{r}
#| echo: false
df1 <- human_ptms_cyto_young %>% filter(ptm_class == 'Post-translational') %>% 
  group_by(Uniprot_entry_name) %>%
  summarise(sum =sum(counts_norm_abund_len))

df2 <- human_ptms_cyto_old %>% filter(ptm_class == 'Post-translational') %>% 
  group_by(Uniprot_entry_name) %>%
  summarise(sum =sum(counts_norm_abund_len))

df3 <- inner_join(df1, df2, by = join_by(Uniprot_entry_name),  suffix = c('_young', '_old')) %>% 
  filter(sum_old > sum_young) %>%
  mutate(change = sum_old/sum_young) %>% filter(change >2) %>%
  arrange(desc(change))

df4 <- inner_join(df1, df2, by = join_by(Uniprot_entry_name),  suffix = c('_young', '_old')) %>% 
  filter(sum_old < sum_young) %>%
  mutate(change = sum_old/sum_young) %>% filter(change <0.5) %>%
  arrange(desc(change))
```

```{r}
#| echo: false
write.table(df3$Uniprot_entry_name, file = '/Users/anastasialinchik/Downloads/up_in_old.tsv', row.names = F, sep="\t", quote = F)
write.table(df4$Uniprot_entry_name, file = '/Users/anastasialinchik/Downloads/down_in_old.tsv', row.names = F, sep="\t", quote = F)
```

This list can be used for DAVID to check for significant enrichment of GO terms.I

# Changes in high disorder/long residence times proteins

There were 3 young donors and 3 elederly donors so can plot histograms instead of density plots.

```{r}
#| echo: false
#| include: false

mt <- read_xlsx(path = '/Users/anastasialinchik/Desktop/Thesis/DATA/MeltingTemperatures.xlsx', sheet = 5,  col_names = T)
mt <- separate_rows(mt, Protein_ID, sep = ";")
mt <- mt %>% dplyr::select(Protein_ID, `Tm Protein`) %>% group_by(Protein_ID) %>% summarise(mean_mt = mean(`Tm Protein`)) %>% rename('LeadProt' = 'Protein_ID')

iupred_scores <- read.csv(file = "/Users/anastasialinchik/Desktop/Thesis/DATA/generated/iupred_scores_with_ratio.tsv", header = T, sep = '\t')

short_lived_proteins_hl <- read_excel(path = '/Users/anastasialinchik/Desktop/Thesis/DATA/short_lived_proteins_hl.xlsx', sheet = 'HEK293T') %>% dplyr::select(`Uniprot ID`, `Half-life`) %>% rename(LeadProt = `Uniprot ID`, mean_hl_hours = `Half-life`)

long_lived_proteins_hl <- read.csv(file = '/Users/anastasialinchik/Desktop/Thesis/DATA/generated/long_proteins_hl_grouped.tsv', sep = '\t', header = T)
```

MT

```{r}
#| echo: false
f <- human_ptms_cyto_young %>% inner_join(mt, by = join_by('LeadProt'))
b <- human_ptms_cyto_old %>% inner_join(mt, by = join_by('LeadProt'))
```

```{r}
#| echo: false
#| warning: false
ggplot() +
  geom_histogram(data = f, aes(x = mean_mt, weight = counts_norm_abund_len, fill = 'young'), alpha = 0.7, bw = 0.6) + 
  geom_histogram(data = b, aes(x = mean_mt, weight = counts_norm_abund_len, fill = 'old'), alpha = 0.7, bw = 0.6) +
  labs(x = 'Melting temperature (°C)', y = 'Density') +
  theme_classic() +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 13, family = "Lato"),
        legend.position = c(0.28,0.9), 
        axis.text = element_text(size = 13, family = "Lato"),  
        axis.title = element_text(size = 13, family = "Lato"))
```

check half-lives and iupred

```{r}
#| echo: false
f <- human_ptms_cyto_young %>% inner_join(iupred_scores, by = join_by('LeadProt' == 'UniProt_ID'))
b <- human_ptms_cyto_old %>% inner_join(iupred_scores, by = join_by('LeadProt' == 'UniProt_ID'))
```

```{r}
#| echo: false
#| warning: false
ggplot() +
  geom_histogram(data = f, aes(x = Ratio_Above_0.5, weight = counts_norm_abund_len, fill = 'young'), alpha = 0.7, bw = 0.6) + 
  geom_histogram(data = b, aes(x = Ratio_Above_0.5, weight = counts_norm_abund_len, fill = 'old'), alpha = 0.7, bw = 0.6) +
  labs(x = 'Proportion of amino acids with a score above 0.5', y = 'Density') +
  theme_classic() +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 13, family = "Lato"),
        legend.position = c(0.28,0.9), 
        axis.text = element_text(size = 13, family = "Lato"),  
        axis.title = element_text(size = 13, family = "Lato"))
```

Short Half-lives

```{r}
#| echo: false
f <- human_ptms_cyto_young %>% inner_join(short_lived_proteins_hl, by = join_by('LeadProt'))
b <- human_ptms_cyto_old %>% inner_join(short_lived_proteins_hl, by = join_by('LeadProt'))
```

```{r}
#| echo: false
#| warning: false
ggplot() +
  geom_histogram(data = f, aes(x = mean_hl_hours, weight = counts_norm_abund_len, fill = 'young')) +
  geom_histogram(data = b, aes(x = mean_hl_hours, weight = counts_norm_abund_len, fill = 'old'), alpha = 0.7, bw = 0.6) +
  scale_x_continuous(limits = c(7,35)) +
  labs(x = 'Mean half-lives (hours)', y = 'Density') +
  theme_classic() +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 16, family = "Lato"),
        legend.position = c(0.8,0.9), 
        axis.text = element_text(size = 16, family = "Lato"),  
        axis.title = element_text(size = 16, family = "Lato"))
```

long half-lives

```{r}
#| echo: false
f <- human_ptms_cyto_young %>% inner_join(long_lived_proteins_hl, by = join_by('LeadProt'))
b <- human_ptms_cyto_old %>% inner_join(long_lived_proteins_hl, by = join_by('LeadProt'))
```

```{r}
#| echo: false
#| warning: false
ggplot() +
  geom_histogram(data = f, aes(x = mean_hl_hours, weight = counts_norm_abund_len, fill = 'young'), alpha = 0.3, bw = 0.6) +
  geom_histogram(data = b, aes(x = mean_hl_hours, weight = counts_norm_abund_len, fill = 'old'), alpha = 0.7, bw = 0.6) + 
  labs(x = 'Mean half-lives (hours)', y = 'Density') +
  theme_classic() +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 16, family = "Lato"),
        legend.position = c(0.8,0.9), 
        axis.text = element_text(size = 16, family = "Lato"),  
        axis.title = element_text(size = 16, family = "Lato"))
```
